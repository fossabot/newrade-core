{"version":3,"sources":["../../src/commands/webpack.ts"],"sourcesContent":["import { spawn, spawnSync } from 'child_process';\n\nimport { Command, Flags } from '@oclif/core';\n\nimport { getShellForPlatform } from '@newrade/core-node-utils';\n\nimport { debugInstance, enableDebug, NS } from '../utilities/log.utilities.js';\n\nexport default class Webpack extends Command {\n  log = debugInstance(`${NS}:webpack`);\n  logWarn = debugInstance(`${NS}:webpack:warn`);\n  logError = debugInstance(`${NS}:webpack:error`);\n\n  static description = 'Shortcut to run webpack with typescript (ts-node)';\n\n  static examples = [`$ nr webpack serve --config webpack.dev.config.ts`];\n\n  static args = [{ name: 'command' }];\n\n  static flags = {\n    config: Flags.string({ char: 'c', description: 'path to config file (.ts)' }),\n    /**\n     * @since webpack-dev-server@v4\n     * @see https://webpack.js.org/configuration/dev-server/#overlay\n     */\n    ['no-client-overlay']: Flags.boolean({\n      description:\n        'disable the full-screen overlay in the browser when there are compiler errors or warnings',\n    }),\n    /**\n     * debugging\n     */\n    ['inspect-brk']: Flags.boolean({\n      description: 'enable node --inspect-brk flag',\n    }),\n  };\n\n  async run() {\n    enableDebug();\n\n    const { args, flags } = await this.parse(Webpack);\n\n    const command = [\n      `cross-env TS_NODE_PROJECT=../../tsconfig.node-cli.json node ${\n        flags['inspect-brk'] ? `--inspect-brk` : ''\n      } -r ts-node/register ../../node_modules/webpack/bin/webpack`,\n      args.command || '',\n      `${flags['no-client-overlay'] ? `--no-client-overlay` : ''}`,\n      `--config ${flags.config}`,\n    ].join(' ');\n\n    this.log(`running: ${command}`);\n\n    this.log(`NODE_ENV is: ${process.env.NODE_ENV}`);\n\n    const cmd = spawn(command, {\n      shell: getShellForPlatform(),\n      stdio: ['inherit', 'pipe', 'pipe'],\n      env: process.env,\n    });\n\n    let errors: any[] = [];\n\n    const handleData = (chunk: Buffer) => {\n      //\n      //\n      //\n      const chunkString = chunk.toString();\n      if (/error\\s/gi.test(chunkString)) {\n        process.stderr.write(chunk);\n\n        if (!/(\\.error)/gi.test(chunkString)) {\n          errors.push(chunkString);\n        }\n\n        return;\n      }\n      process.stdout.write(chunk);\n    };\n\n    const handleError = (error: Error) => {\n      errors.push(error.toString());\n      process.stderr.write(error.toString());\n    };\n\n    const handleClose = (args: any[]) => {\n      if (errors.length) {\n        this.logError(`finished with ${errors.length} errors`);\n        errors.forEach((error, errorIndex) => {\n          this.logError(`error #${errorIndex}:`);\n          process.stderr.write(`\\t${error.toString()}`);\n        });\n\n        process.exit(1);\n      }\n      this.log(`finished`);\n      process.exit(0);\n    };\n\n    cmd.stdout.on('data', handleData);\n    cmd.stderr.on('data', handleData);\n\n    cmd.stdout.on('error', handleError);\n    cmd.stderr.on('error', handleError);\n\n    cmd.stdout.on('close', handleClose);\n    cmd.stderr.on('close', handleClose);\n  }\n}\n"],"names":["Webpack","Command","log","debugInstance","NS","logWarn","logError","description","examples","args","name","flags","config","Flags","string","char","boolean","run","enableDebug","parse","command","join","process","env","NODE_ENV","cmd","spawn","shell","getShellForPlatform","stdio","errors","handleData","chunk","chunkString","toString","test","stderr","write","push","stdout","handleError","error","handleClose","length","forEach","errorIndex","exit","on"],"mappings":"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"}